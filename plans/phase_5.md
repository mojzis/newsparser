# Phase 5: Simple HTML Report Generation

## Overview
Phase 5 focuses on creating clean, minimalist HTML reports in the style of early Google - white background, blue links, and witty AI-generated perexes. The homepage shows the latest day's articles with links to previous days.

## Design Principles
- **Simplicity First**: Clean, minimal design like Google circa 2000
- **Content Focus**: Articles are the star, not the design
- **Witty Summaries**: Brief, slightly funny perexes generated by Claude
- **Easy Navigation**: Clear links to articles and original Bluesky posts
- **Fast Loading**: Minimal CSS, no JavaScript, pure HTML

## Technical Requirements
- Generate static HTML files
- Store locally in `output/reports/YYYY/MM/DD/report.html`
- Create index.html at `output/index.html` 
- Use Jinja2 for templating
- Keep file sizes small for fast loading
- Future: Easy migration to R2/S3/static hosting

## MVP Features
1. **Daily Report Page**
   - List of articles from that day
   - Each article includes:
     - Title (linked to article)
     - Witty perex (50-100 words)
     - Link to original Bluesky post
     - Author and timestamp
   
2. **Homepage (index.html)**
   - Shows latest day's articles
   - Archive section with links to previous days
   - Simple header with project name
   - Generated daily, overwrites previous

3. **Styling**
   - White background
   - Blue links (#0000EE for unvisited, #551A8B for visited)
   - Black text
   - Simple typography (Arial/sans-serif)
   - Minimal spacing and padding

## Implementation Tasks

### Task 1: Create Report Data Models
- [x] Define ReportArticle model for template data
- [x] Define ReportDay model for daily aggregation
- [x] Create conversion methods from BlueskyPost + ArticleEvaluation
- [x] Add perex generation placeholder
**Command**: `nsp generate-report --date YYYY-MM-DD --dry-run`

### Task 2: Set Up Jinja2 Templates
- [x] Create base template with minimal HTML5 structure
- [x] Create daily report template
- [x] Create homepage template
- [x] Add CSS styles (inline or minimal stylesheet)
**Command**: `nsp preview-template --template daily`

### Task 3: Use Pre-generated Perexes
- [ ] Add perex field to ArticleEvaluation model (Phase 3 update)
- [ ] Update Anthropic prompt in Phase 3 to include perex generation
- [ ] Use stored perexes from evaluations.parquet
- [ ] Add fallback to summary if perex not available
- [ ] Handle legacy data without perexes
**Note**: Perexes will be generated during Phase 3 evaluation to avoid duplicate API calls

### Task 4: Build Report Generator
- [ ] Load posts and evaluations for a day
- [ ] Filter for relevant articles only
- [ ] Generate perexes for each article
- [ ] Render HTML using templates
- [ ] Handle missing data gracefully
**Command**: `nsp generate-report --date YYYY-MM-DD`

### Task 5: Create Archive System
- [ ] List all available report dates
- [ ] Generate homepage with latest + archive
- [ ] Update homepage after each daily report
- [ ] Create navigation between days
**Command**: `nsp update-homepage`

### Task 6: Local Output Directory
- [ ] Create output directory structure (output/reports/YYYY/MM/DD/)
- [ ] Save daily reports locally
- [ ] Save homepage to output/index.html
- [ ] Create symlinks for easy access
- [ ] Add output directory to .gitignore
**Command**: `nsp publish-report --date YYYY-MM-DD --output-dir ./output`

## Template Structure

### Base Template (base.html)
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}MCP Monitor{% endblock %}</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 40px auto; 
            padding: 0 20px;
            background: white;
            color: black;
        }
        a { color: #0000EE; }
        a:visited { color: #551A8B; }
        .header { 
            font-size: 24px; 
            margin-bottom: 20px;
            font-weight: normal;
        }
        .article { margin-bottom: 30px; }
        .meta { color: #666; font-size: 14px; }
        .perex { margin: 10px 0; }
        .archive { 
            margin-top: 40px; 
            padding-top: 20px; 
            border-top: 1px solid #ccc;
        }
    </style>
</head>
<body>
    {% block content %}{% endblock %}
</body>
</html>
```

### Daily Report Template
```html
{% extends "base.html" %}
{% block title %}MCP Monitor - {{ date }}{% endblock %}
{% block content %}
<div class="header">
    <a href="/">MCP Monitor</a> - {{ date_formatted }}
</div>

{% for article in articles %}
<div class="article">
    <div><a href="{{ article.url }}">{{ article.title }}</a></div>
    <div class="perex">{{ article.perex }}</div>
    <div class="meta">
        via <a href="{{ article.bluesky_url }}">{{ article.author }}</a> 
        • {{ article.timestamp }}
    </div>
</div>
{% endfor %}

<div class="archive">
    <a href="/">← Back to latest</a>
</div>
{% endblock %}
```

### Homepage Template
```html
{% extends "base.html" %}
{% block content %}
<div class="header">MCP Monitor</div>
<div style="margin-bottom: 20px; color: #666;">
    Daily digest of Model Context Protocol discussions
</div>

<h2 style="font-size: 18px; font-weight: normal;">
    Today's Articles ({{ today }})
</h2>

{% for article in today_articles %}
<div class="article">
    <div><a href="{{ article.url }}">{{ article.title }}</a></div>
    <div class="perex">{{ article.perex }}</div>
    <div class="meta">
        via <a href="{{ article.bluesky_url }}">{{ article.author }}</a> 
        • {{ article.timestamp }}
    </div>
</div>
{% endfor %}

<div class="archive">
    <h3 style="font-size: 16px;">Previous Days</h3>
    {% for date in archive_dates %}
    <div><a href="/reports/{{ date.path }}">{{ date.formatted }}</a></div>
    {% endfor %}
</div>
{% endblock %}
```

## Phase 3 Integration

Since perex generation happens during Phase 3 evaluation, we need to:

1. **Update ArticleEvaluation model** to include a `perex` field
2. **Modify the Anthropic evaluation prompt** to generate perexes alongside other evaluation data
3. **Store perexes in evaluations.parquet** for use in report generation

This approach:
- Saves API costs (one call instead of two)
- Ensures consistency between evaluation and perex
- Simplifies the report generation pipeline
- Reduces latency during report generation

## Data Flow

1. **Load Data**
   - Get posts from `data/YYYY/MM/DD/posts.parquet`
   - Get evaluations from `data/YYYY/MM/DD/evaluations.parquet`
   - Join on URL

2. **Filter & Process**
   - Keep only is_mcp_related=True
   - Sort by relevance_score
   - Limit to top 20-30 articles

3. **Use Pre-generated Perexes**
   - Load perex from ArticleEvaluation
   - Use summary as fallback for legacy data
   - No additional API calls needed

4. **Render HTML**
   - Create daily report
   - Update homepage
   - Minimal, fast-loading HTML

5. **Save to Local Output**
   - Daily report to `output/reports/YYYY/MM/DD/report.html`
   - Homepage to `output/index.html`
   - Create directories as needed

## Success Criteria

### Functional
- Reports generated successfully for each day with data
- All article links work correctly
- Bluesky post links work correctly
- Archive navigation works
- Perexes are engaging and appropriate

### Performance
- Report generation < 30 seconds
- HTML files < 100KB
- Page load time < 1 second
- No JavaScript required

### Design
- Clean, Google-like appearance
- Easy to scan and read
- Mobile-friendly without extra CSS
- Accessible (proper HTML structure)

## Testing Strategy

### Unit Tests
- Template rendering with mock data
- Perex generation mocking
- Data filtering and sorting
- Date formatting and paths

### Integration Tests
- Full pipeline from data to HTML
- Local file writing verification
- Archive generation
- Error handling scenarios
- Directory creation tests

### Manual Testing
- Visual review of generated HTML
- Link verification
- Mobile device testing
- Browser compatibility

## Error Handling

### Missing Data
- Skip days without data in archive
- Show message if no articles for a day
- Continue processing other days

### API Failures
- Use article summary if perex generation fails
- Log failures but continue processing
- Retry logic for transient failures

### Template Errors
- Validate data before rendering
- Provide clear error messages
- Fall back to simple format if needed

## Future Enhancements (NOT MVP)
- RSS feed generation
- Search functionality
- Tag/topic pages
- Statistics page
- JSON API for data

## Estimated Timeline
- Task 1-2: 2 hours (models and templates)
- Task 3: 0.5 hours (use pre-generated perexes from Phase 3)
- Task 4-5: 3 hours (report generation and archive)
- Task 6: 0.5 hours (local file output)
- Testing: 2 hours

**Total: ~8 hours for MVP** (simplified with local storage)

## Next Steps
After Phase 5, the system will have:
- Daily HTML reports with witty summaries
- Simple, fast-loading design
- Easy navigation between days
- Foundation for Phase 6 (Bluesky publishing)